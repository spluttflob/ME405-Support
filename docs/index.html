<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ME405 Library: Main Page</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
  $(document).ready(function() { init_search(); });
/* @license-end */
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="ME405-logo.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">ME405 Library
   &#160;<span id="projectnumber">Version 0.38</span>
   </div>
   <div id="projectbrief">Python library in support of ME405 class</div>
  </td>
   <td>        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.svg"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.svg" alt=""/></a>
          </span>
        </div>
</td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search','.html');
/* @license-end */
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('index.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">ME405 Library Documentation</div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="ss_intro"></a>
Introduction</h1>
<p>The ME405 Python code library contains a set of routines which implement a simple cooperative scheduler that runs in MicroPython. This library is used for teaching the development of mechatronic systems, including modestly complex real-time software for use in embedded systems. Its use is not recommended in production systems because the code has not been thoroughly tested to ensure reliability. As of this writing, the same warning should be made for MicroPython, on which this software is based; as a new product, MicroPython still has bugs and features which significantly affect reliability. It is expected that the reliability of both ME405 code and MicroPython will improve rapidly in the next few years, and users of this code are encouraged to contribute to the development of both.</p>
<h1><a class="anchor" id="ss_hardware"></a>
Hardware</h1>
<p>The ME405 course runs MicroPython on Nucleo-64<sup>TM</sup> boards from ST Microelectronics, taking advantage of the boards' high value for the money (we're a state supported school teaching some of the best of the 99%). We usually employ a simple custom board called the Shoe of Brian which sits below the Nucleo and houses a USB OTG "On-The-Go" connector. The USB OTG connector allows mounting some of the microcontroller's flash memory as a USB file system, making for convenient programming. We prefer to leave the Nucleo's ST-Link 2.1 programmer attached so that the board can be programmed in C++ for high-performance applications if needed in other mechatronics and Senior project courses. The ME405 software was deleloped using a Nucleo-L476RG board; this version works much better for our purposes than the -F401 and -F411 versions because of the much larger available flash memory. The processors with 512MB flash cannot easily accommodate MicroPython itself plus a substantial group of Python programs such as the ME405 software suite, unless provided with SD cards, which add to the expense and complexity of the system.</p>
<h2><a class="anchor" id="ss_build"></a>
Build Your Own</h2>
<p>If you are interested in building your own ME405 circuit, please refer to the following page: <a class="el" href="shoe_info.html">The Shoe of Brian</a></p>
<p>If you'd rather not build your own board, note that many STM32 Discovery<sup>TM</sup> boards are supplied with built-in USB OTG connectors, allowing similarly convenient programming without having to build custom circuitry. The original MicroPython PyBoard has both USB OTG and Micro-SD card connectors and makes an excellent platform for this software, though minor modifications may be needed to accommodate the slightly different processor and pinouts.</p>
<h2><a class="anchor" id="prepshoe"></a>
Preparing Nucleo-64s for ME405</h2>
<p>As shipped, 64-pin Nucleo<sup>TM</sup> boards get power from the USB connector on the ST-Link programmer attached to those boards. In order to be powered from the Shoe of Brian boards underneath and reliably operate their USB-OTG file systems, Nucleo-64 boards need their JP5 jumpers moved from the as-delivered connection of pins 1 to 2 to the other side of the header block, pins 2 to 3. See ST's user manual UM1724, the user manual for Nucleo-64 boards for more details and schematics. <em>Strangeness:</em> One batch of STM32L476RG boards has worked without moving this jumper, but another batch requires the jumper to be moved to operate correctly.</p>
<h1><a class="anchor" id="ss_modules"></a>
Components</h1>
<ul>
<li>The basic functionality of cooperatively (mostly) multitasking real-time software is provided in <code><a class="el" href="cotask_8py.html" title="This file contains classes to run cooperatively scheduled tasks in a multitasking system.">cotask.py</a></code>.</li>
<li>Communication of information between tasks, including thread-safe transfer of data between interrupt service routines and cooperatively scheduled "regular" tasks, is supported by code in <code><a class="el" href="task__share_8py.html" title="This file contains classes which allow tasks to share data without the risk of data corruption by int...">task_share.py</a></code>.</li>
<li>A number of device drivers are provided, while others are left as an exercise for the student.</li>
</ul>
<h1><a class="anchor" id="sqref"></a>
Quick Reference</h1>
<p>This section contains some quick hints about how to use various functions of the Nucleo<sup>TM</sup> boards with MicroPython as they are set up for ME405.</p>
<h2><a class="anchor" id="sstiming"></a>
Timing</h2>
<p>MicroPython has two time related libraries, <code>time</code> and <code>utime</code>, which provide the same functionality. The use of <code>utime</code> is recommended to avoid confusion with the standard Python library called <code>time</code>, which has different functionality.</p>
<p>Reference: <a href="https://docs.micropython.org/en/latest/pyboard/library/utime.html">https://docs.micropython.org/en/latest/pyboard/library/utime.html</a> </p><div class="fragment"><div class="line"><span class="keyword">import</span> utime</div>
<div class="line">utime.sleep (0.5)       <span class="comment"># Sleep for 0.5 sec, blocking tasks (bad)</span></div>
<div class="line">utime.sleep_us (10)     <span class="comment"># Sleep for only 10 us, which is usually OK</span></div>
<div class="line"> </div>
<div class="line"><span class="comment"># The following measures how long a function takes to run in microseconds</span></div>
<div class="line">start_time = utime.ticks_us ()</div>
<div class="line">run_my_function ()</div>
<div class="line">duration = utime.ticks_diff (utime.ticks_us, start_time)</div>
</div><!-- fragment --><h2><a class="anchor" id="sspins"></a>
GPIO Pins</h2>
<p>Reference: <a href="https://docs.micropython.org/en/latest/pyboard/library/pyb.Pin.html">https://docs.micropython.org/en/latest/pyboard/library/pyb.Pin.html</a> </p><div class="fragment"><div class="line"><span class="comment"># Set up a pin as an output and control it</span></div>
<div class="line">pinC0 = pyb.Pin (pyb.Pin.board.PC0, pyb.Pin.OUT_PP)</div>
<div class="line">pinC0.high ()</div>
<div class="line">pinC0.low ()</div>
<div class="line"> </div>
<div class="line"><span class="comment"># Set up another pin as an input and read it</span></div>
<div class="line">pinC1 = pyb.Pin (pyb.Pin.board.PC1, pyb.Pin.IN)</div>
<div class="line"><span class="keywordflow">if</span> pinC1.value ():</div>
<div class="line">    <span class="keywordflow">print</span> (<span class="stringliteral">&quot;Pin C1 is high. Is that legal now?&quot;</span>)</div>
</div><!-- fragment --><h2><a class="anchor" id="ssextint"></a>
External Interrupts</h2>
<p>Reference: <a href="https://docs.micropython.org/en/latest/pyboard/library/pyb.ExtInt.html">https://docs.micropython.org/en/latest/pyboard/library/pyb.ExtInt.html</a> </p><div class="fragment"><div class="line">isr_count = 0</div>
<div class="line"><span class="keyword">def </span>count_isr (which_pin):        <span class="comment"># Create an interrupt service routine</span></div>
<div class="line">    <span class="keyword">global</span> isr_count</div>
<div class="line">    isr_count += 1</div>
<div class="line"> </div>
<div class="line">extint = pyb.ExtInt (pyb.Pin.board.PC0,   <span class="comment"># Which pin</span></div>
<div class="line">             pyb.ExtInt.IRQ_RISING,       <span class="comment"># Interrupt on rising edge</span></div>
<div class="line">             pyb.Pin.PULL_UP,             <span class="comment"># Activate pullup resistor</span></div>
<div class="line">             count_isr)                   <span class="comment"># Interrupt service routine</span></div>
<div class="line"> </div>
<div class="line"><span class="comment"># After some events have happened on the pin...</span></div>
<div class="line"><span class="keywordflow">print</span> (isr_count)</div>
</div><!-- fragment --><h2><a class="anchor" id="sstimers"></a>
Timers and Timer Interrupts</h2>
<p>The frequency given in the <code>freq</code> parameter of the <code>pyb.Timer</code> constructor is the frequency at which the timer overflows and restarts counting at zero. When using timer interrupts, this is the frequency at which interrupts occur. Only certain pins can be used with timers. Look for pins associated with the channels of timers in the STM32 data sheet.</p>
<p>Reference: <a href="https://docs.micropython.org/en/latest/pyboard/library/pyb.Timer.html">https://docs.micropython.org/en/latest/pyboard/library/pyb.Timer.html</a> </p><div class="fragment"><div class="line">timmy = pyb.Timer (1, freq = 1000)             <span class="comment"># Timer 1 running at 1000 Hz</span></div>
<div class="line">timmy.counter ()                               <span class="comment"># Get timer value</span></div>
<div class="line">timer.freq (100)                               <span class="comment"># Change rollover rate</span></div>
<div class="line"> </div>
<div class="line"><span class="comment"># Define a function that toggles the pin and set it as the interrupt</span></div>
<div class="line"><span class="comment"># service routine. Uses pinC0 from above</span></div>
<div class="line"><span class="keyword">def </span>toggler (which_timer):</div>
<div class="line">    <span class="keywordflow">if</span> pinC0.value ():</div>
<div class="line">        pinC0.low ()</div>
<div class="line">    <span class="keywordflow">else</span>:</div>
<div class="line">        pinC0.high ()</div>
<div class="line"> </div>
<div class="line">timmy.callback (toggler)</div>
</div><!-- fragment --><h2><a class="anchor" id="sspwm"></a>
Pulse Width Modulation</h2>
<p>Only certain pins can be used for PWM. Look for pins associated with the channels of timers in the STM32 data sheet.</p>
<p>Reference: <a href="https://docs.micropython.org/en/latest/pyboard/library/pyb.Timer.html">https://docs.micropython.org/en/latest/pyboard/library/pyb.Timer.html</a> </p><div class="fragment"><div class="line">pinA1 = pyb.Pin (pyb.Pin.board.PA1, pyb.Pin.OUT_PP)</div>
<div class="line">tim2 = pyb.Timer (2, freq=1000)</div>
<div class="line">ch2 = tim2.channel (2, pyb.Timer.PWM, pin=pinA1)</div>
<div class="line">ch2.pulse_width_percent (30)</div>
</div><!-- fragment --><h2><a class="anchor" id="ssadc"></a>
Analog to Digital Conversion (ADC or A/D)</h2>
<p>It is very important to apply only voltages in the range from 0 to 3.3V to each A/D pin. Excessive or negative voltages can destroy things. Not all pins can be used as A/D pins; see the STM32 datasheet pin alternate function table to find out which ones will work (or just try some in the REPL and see which don't give you a <code>ValueError</code> ).</p>
<p>Reference: <a href="https://docs.micropython.org/en/latest/pyboard/library/pyb.ADC.html">https://docs.micropython.org/en/latest/pyboard/library/pyb.ADC.html</a> </p><div class="fragment"><div class="line">adcpin = pyb.ADC (pyb.Pin.board.PA4)</div>
<div class="line">volts = adcpin.read ()</div>
</div><!-- fragment --><h2><a class="anchor" id="ssdac"></a>
Digital to Analog Conversion (DAC or D/A)</h2>
<p>Some STM32 chips have digial to analog converters, and others don't. Digital to analog conversion is not officially supported on ME405 boards, but you can look for class <code>pyb.DAC</code> and if it's there, search for MicroPython documentation on how to use it.</p>
<h2><a class="anchor" id="ssi2c"></a>
I²C</h2>
<p>The following example is for hardware I&sup2;C on the STM32.</p>
<p>Reference: <a href="https://docs.micropython.org/en/latest/pyboard/library/pyb.I2C.html">https://docs.micropython.org/en/latest/pyboard/library/pyb.I2C.html</a> </p><div class="fragment"><div class="line">i2c1 = pyb.I2C (1, pyb.I2C.CONTROLLER, baudrate = 100000)</div>
<div class="line">i2c1.scan ()                             <span class="comment"># Check for devices on the bus</span></div>
<div class="line">i2c1.mem_write (<span class="stringliteral">&#39;\x07&#39;</span>, 0x2A, 0x05)      <span class="comment"># Send a 7 to sensor at 0x2A, register 0x05</span></div>
<div class="line">buffy = bytearray(2)                     <span class="comment"># To store </span></div>
<div class="line">i2c1.mem_read (buffy, 0x2A, 0x07)        <span class="comment"># Read 2 bytes from register 0x07 into buffy</span></div>
<div class="line">rsp = i2c1.mem_read (2, 0x2A, 0x07)      <span class="comment"># Or read and return 2 bytes from register 0x07</span></div>
</div><!-- fragment --><h2><a class="anchor" id="flashprob"></a>
Flash Memory Problems</h2>
<p>It is possible that the flash memory on a Nucleo may become corrupted. This problem seems to manifest itself by read or write errors with source files on the PYBFLASH drive, or by Thonny complaining about its backend. A solution may be attempted by reformatting the processor's internal flash drive (unless you are using a MicroSD card, in which case just take that out and reformat it in a PC). The following procedures should reformat the flash, but your mileage may vary. <br  />
 There are <b>no</b> <b>guarantees</b> this will work and not harm your system. Before you run these commands, make sure to back up any files on the MicroPython board if you can read them.</p>
<p><b>Recommended</b> <b>Procedure</b> - as of 2024, anyway</p>
<p>Hold the blue button down and briefly push the black reset button <b>while continuing to hold the blue button.</b> The green LED will blink once, then twice, then three times; after the three flashes, release the blue button and wait a few seconds while the green light does more blinky things &ndash; and then wait another 10 seconds after it stops. Your <code>PYBFLASH</code> drive should now be freshly formatted. Unplug the board from your PC to power it off, wait a few seconds, then plug it back in. All files except <code>boot.py</code>, <code>main.py</code>, <code>pybcdc.inf</code>, and <code>README.txt</code> should be gone. If your old files are still there, try ejecting (or unmounting, or "removing" depending on what your OS calls it) the PYBFLASH drive on the PC, then unplugging the MicroPython board, waiting several seconds, and plugging it in again.</p>
<p>Reference: <a href="https://docs.micropython.org/en/latest/pyboard/pyboard/tutorial/reset.html">https://docs.micropython.org/en/latest/pyboard/pyboard/tutorial/reset.html</a></p>
<p><b>Alternative</b> <b>Procedure</b> - MicroPython 1.13 from 2021 and later (maybe)</p>
<p>Make sure you're at the REPL prompt and run the following lines: </p><div class="fragment"><div class="line"><span class="keyword">import</span> os, pyb</div>
<div class="line">os.umount (<span class="stringliteral">&#39;/flash&#39;</span>)</div>
<div class="line">os.VfsFat.mkfs (pyb.Flash (start=0))</div>
<div class="line">os.mount (pyb.Flash (start=0), <span class="stringliteral">&#39;/flash&#39;</span>)</div>
<div class="line">os.chdir (<span class="stringliteral">&#39;/flash&#39;</span>)</div>
</div><!-- fragment --><p> The flash drive may lose its name <b>PYBFLASH</b> and get a random numerical name, but it will have been newly set up and should work well again.</p>
<dl class="section copyright"><dt>Copyright</dt><dd>The ME405 software suite is copyright 2016-2024 by JR Ridgely and released under the GNU Public License, version 3. It intended for educational use only, but its use is not limited thereto. THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE. </dd></dl>
</div></div><!-- PageDoc -->
</div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated on Tue Feb 27 2024 21:50:10 for ME405 Library by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.1 </li>
  </ul>
</div>
</body>
</html>
