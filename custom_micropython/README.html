<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>Building the ME405 Custom MicroPython</title>
  <style>
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    span.underline{text-decoration: underline;}
    div.column{display: inline-block; vertical-align: top; width: 50%;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    ul.task-list{list-style: none;}
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        color: #aaaaaa;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
    div.sourceCode
      {   }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span.al { color: #ff0000; font-weight: bold; } /* Alert */
    code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
    code span.at { color: #7d9029; } /* Attribute */
    code span.bn { color: #40a070; } /* BaseN */
    code span.bu { } /* BuiltIn */
    code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
    code span.ch { color: #4070a0; } /* Char */
    code span.cn { color: #880000; } /* Constant */
    code span.co { color: #60a0b0; font-style: italic; } /* Comment */
    code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
    code span.do { color: #ba2121; font-style: italic; } /* Documentation */
    code span.dt { color: #902000; } /* DataType */
    code span.dv { color: #40a070; } /* DecVal */
    code span.er { color: #ff0000; font-weight: bold; } /* Error */
    code span.ex { } /* Extension */
    code span.fl { color: #40a070; } /* Float */
    code span.fu { color: #06287e; } /* Function */
    code span.im { } /* Import */
    code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
    code span.kw { color: #007020; font-weight: bold; } /* Keyword */
    code span.op { color: #666666; } /* Operator */
    code span.ot { color: #007020; } /* Other */
    code span.pp { color: #bc7a00; } /* Preprocessor */
    code span.sc { color: #4070a0; } /* SpecialChar */
    code span.ss { color: #bb6688; } /* SpecialString */
    code span.st { color: #4070a0; } /* String */
    code span.va { color: #19177c; } /* Variable */
    code span.vs { color: #4070a0; } /* VerbatimString */
    code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
  <style type="text/css">

html {
font-size: 62.5%;
font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
}
body {
font-size: 1.8rem;
line-height: 1.618;
max-width: 38em;
margin: auto;
color: #4a4a4a;
background-color: #f9f9f9;
padding: 13px;
}
@media (max-width: 684px) {
body {
font-size: 1.53rem;
}
}
@media (max-width: 382px) {
body {
font-size: 1.35rem;
}
}
h1, h2, h3, h4, h5, h6 {
line-height: 1.1;
font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
font-weight: 700;
margin-top: 3rem;
margin-bottom: 1.5rem;
overflow-wrap: break-word;
word-wrap: break-word;
-ms-word-break: break-all;
word-break: break-word;
}
h1 {
font-size: 1.6em; color: #0000D0;
}
h2 {
font-size: 1.3em; color: #0000D0; background: #F0F0F0;
}
h3 {
font-size: 1.25em; color: #0000D0; background: #F0F0F0;
}
h4 {
font-size: 1.1em; color: #0000D0;
}
h5 {
font-size: 1.05em; color: #0000D0;
}
h6 {
font-size: 1em; icolor: #0000D0;
}
p {
margin-top: 0px;
margin-bottom: 2.5rem;
}
small, sub, sup {
font-size: 75%;
}
hr {
border-color: #1d7484;
}
a {
text-decoration: none;
color: #1d7484;
}
a:visited {
color: #144f5a;
}
a:hover {
color: #982c61;
border-bottom: 2px solid #4a4a4a;
}
ul {
padding-left: 1.4em;
margin-top: 0px;
margin-bottom: 2.5rem;
}
li {
margin-bottom: 0.4em;
}
blockquote {
margin-left: 0px;
margin-right: 0px;
padding-left: 1em;
padding-top: 0.8em;
padding-bottom: 0.8em;
padding-right: 0.8em;
border-left: 5px solid #1d7484;
margin-bottom: 2.5rem;
background-color: #f1f1f1;
}
blockquote p {
margin-bottom: 0;
}
img, video {
height: auto;
max-width: 100%;
margin-top: 0px;
margin-bottom: 2.5rem;
}

pre {
background-color: #f8f4e8;
display: block;
padding: 1em;
overflow-x: auto;
margin-top: 0px;
margin-bottom: 2.5rem;
font-size: 0.9em;
}
code, kbd, samp {
font-size: 0.9em;
padding: 0 0.5em;
background-color: #f8f4e8;
white-space: pre-wrap;
}
pre > code {
padding: 0;
background-color: transparent;
white-space: pre;
font-size: 1em;
}

table {
text-align: justify;
width: 100%;
border-collapse: collapse;
margin-bottom: 2rem;
}
td, th {
padding: 0.5em;
border-bottom: 1px solid #f1f1f1;
}

input, textarea {
border: 1px solid #4a4a4a;
}
input:focus, textarea:focus {
border: 1px solid #1d7484;
}
textarea {
width: 100%;
}
.button, button, input[type=submit], input[type=reset], input[type=button], input[type=file]::file-selector-button {
display: inline-block;
padding: 5px 10px;
text-align: center;
text-decoration: none;
white-space: nowrap;
background-color: #1d7484;
color: #f9f9f9;
border-radius: 1px;
border: 1px solid #1d7484;
cursor: pointer;
box-sizing: border-box;
}
.button[disabled], button[disabled], input[type=submit][disabled], input[type=reset][disabled], input[type=button][disabled], input[type=file]::file-selector-button[disabled] {
cursor: default;
opacity: 0.5;
}
.button:hover, button:hover, input[type=submit]:hover, input[type=reset]:hover, input[type=button]:hover, input[type=file]::file-selector-button:hover {
background-color: #982c61;
color: #f9f9f9;
outline: 0;
}
.button:focus-visible, button:focus-visible, input[type=submit]:focus-visible, input[type=reset]:focus-visible, input[type=button]:focus-visible, input[type=file]::file-selector-button:focus-visible {
outline-style: solid;
outline-width: 2px;
}
textarea, select, input {
color: #4a4a4a;
padding: 6px 10px; 
margin-bottom: 10px;
background-color: #f1f1f1;
border: 1px solid #f1f1f1;
border-radius: 4px;
box-shadow: none;
box-sizing: border-box;
}
textarea:focus, select:focus, input:focus {
border: 1px solid #1d7484;
outline: 0;
}
input[type=checkbox]:focus {
outline: 1px dotted #1d7484;
}
label, legend, fieldset {
display: block;
margin-bottom: 0.5rem;
font-weight: 600;
}
</style>
</head>
<body>
<h1 id="building-the-me405-custom-micropython">Building the ME405 Custom MicroPython</h1>
<p><strong>Most Recent Update:</strong> November 2023 for MicroPython version 1.22.0-preview.</p>
<p>These instructions should help you set up an environment to build MicroPython for the ME405 board set, which includes:</p>
<ul>
<li><p>An IHM04A1 motor driver board on top</p></li>
<li><p>An STM32L476RG Nucleo in the middle</p></li>
<li><p>A Shoe of Brian custom board on the bottom</p></li>
</ul>
<p>It should be possible to do this on any of the common operating systems. The author uses Linux Mint.</p>
<h2 id="building-stock-micropython">Building Stock MicroPython</h2>
<p>You should first set up a build environment for regular MicroPython. Make sure to set up the MicroPython subdirectory in its own folder on your computer, as you may want to add other modules in that directory, next to the MicroPython source code directory tree. Instructions for downloading and setting up MicroPython source code are found at:</p>
<p><a href="https://docs.micropython.org/en/latest/develop/gettingstarted.html" class="uri">https://docs.micropython.org/en/latest/develop/gettingstarted.html</a></p>
<p>When following all the instructions carefully (which you <em>gotta</em> do), be sure to pay extra attention to the section “Building the STM32 port.”</p>
<h2 id="custom-micropython-files">Custom MicroPython Files</h2>
<p>You need to add some custom files, and custom modified versions of stock files, in the MicroPython source tree. Custom versions of these files are arranged in directories under this one which match the arrangement of directories in the stock MicroPython source tree. Custom files whose names match those of existing files should overwrite the stock files, and files which don’t exist in the stock version may just be placed in the correct directories.</p>
<h4 id="highlights">Highlights</h4>
<p>The most important customized things are in the files shown in the tree below.</p>
<p><strong><code>mpconfigboard.h</code></strong> Selects which pins are used for which peripherals. The most important section controls the UART which is used for the REPL:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true"></a><span class="pp">#define MICROPY_HW_UART1_TX         (pin_B6)</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true"></a><span class="pp">#define MICROPY_HW_UART1_RX         (pin_B7)</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true"></a><span class="pp">#define MICROPY_HW_UART1_CTS        (pin_B4)</span></span></code></pre></div>
<p><strong><code>makefile</code></strong> This file contains a custom setup so that one can compile MicroPython for the desired target, using the desired extra modules, by just typing <code>make</code> at a Linux/Unix command prompt. After applying custom settings, this file calls the stock <code>Makefile</code> which need not be modified. Notice that in a Mac™ or Unix™ or Linux environment, the two files <code>makefile</code> and <code>Makefile</code> are seen as two <em>different</em> files.</p>
<h2 id="extra-packages">Extra Packages</h2>
<p>For ME405, we add two extra packages. First, a directory called <code>modules</code> is created in the same directory where the base <code>micropython</code> directory lives (this is <em>not</em> the <code>user_mods</code> directory inside the MicroPython source tree).</p>
<ul>
<li><p><strong>ulab</strong> is a partial NumPy workalike which allows fast, convenient manipulation of data. It is found on GitHub™ at<br />
<a href="https://github.com/v923z/micropython-ulab" class="uri">https://github.com/v923z/micropython-ulab</a><br />
We install it by cloning the GitHub repository inside the <code>modules</code> directory.</p></li>
<li><p><strong>cqueue</strong> is a set of custom classes which implement fast queues to carry data from tasks to other tasks. These are hosted on GitHub™ at<br />
&lt;&gt;</p></li>
</ul>
<h2 id="the-micropython-source-tree">The MicroPython Source Tree</h2>
<p>A partial listing of the source tree, highlighting the files of most interest to compiling the ME405 code, is shown below. Since there are <em>lots</em> of files in the tree, the contents of directories in which we do not need to make modifications are not shown, and bunches of directories containing ports in which we’re not necessarily interested are replaced with ellipses (<code>...</code>).</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true"></a>modules</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true"></a>├── cqueue</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true"></a>│   ├── cqueue.c</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true"></a>│   ├── micropython.cmake</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true"></a>│   └── micropython.mk</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true"></a>└── ulab</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true"></a>    └── ...</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true"></a>micropython</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true"></a>├── docs</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true"></a>├── drivers</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true"></a>├── examples</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true"></a>├── extmod</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true"></a>├── lib</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true"></a>├── LICENSE</span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true"></a>├── logo</span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true"></a>├── mpy-cross</span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true"></a>├── ports</span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true"></a>│   ├── bare-arm</span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true"></a>│   ├── cc3200</span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true"></a>│   ├── embed</span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true"></a>│   ├── esp32</span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true"></a>│   ├── ...</span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true"></a>│   ├── rp2</span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true"></a>│   ├── samd</span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true"></a>│   ├── stm32</span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true"></a>│   │   ├── boards</span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true"></a>│   │   │   ├── ...</span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true"></a>│   │   │   ├── NUCLEO_L476RG</span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true"></a>│   │   │   │   ├── board.json</span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true"></a>│   │   │   │   ├── mpconfigboard.h</span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true"></a>│   │   │   │   ├── mpconfigboard.mk</span>
<span id="cb2-32"><a href="#cb2-32" aria-hidden="true"></a>│   │   │   │   ├── pins.csv</span>
<span id="cb2-33"><a href="#cb2-33" aria-hidden="true"></a>│   │   │   │   └── stm32l4xx_hal_conf.h</span>
<span id="cb2-34"><a href="#cb2-34" aria-hidden="true"></a>│   │   │   ├── NUCLEO_L4A6ZG</span>
<span id="cb2-35"><a href="#cb2-35" aria-hidden="true"></a>│   │   │   ├── NUCLEO_WB55</span>
<span id="cb2-36"><a href="#cb2-36" aria-hidden="true"></a>│   │   │   ├── ...</span>
<span id="cb2-37"><a href="#cb2-37" aria-hidden="true"></a>│   │   │   └── VCC_GND_H743VI</span>
<span id="cb2-38"><a href="#cb2-38" aria-hidden="true"></a>│   │   ├── makefile</span>
<span id="cb2-39"><a href="#cb2-39" aria-hidden="true"></a>│   │   ├── Makefile</span>
<span id="cb2-40"><a href="#cb2-40" aria-hidden="true"></a>│   │   └── README.md</span>
<span id="cb2-41"><a href="#cb2-41" aria-hidden="true"></a>│   ├── unix</span>
<span id="cb2-42"><a href="#cb2-42" aria-hidden="true"></a>│   ├── webassembly</span>
<span id="cb2-43"><a href="#cb2-43" aria-hidden="true"></a>│   ├── windows</span>
<span id="cb2-44"><a href="#cb2-44" aria-hidden="true"></a>└── zephyr</span>
<span id="cb2-45"><a href="#cb2-45" aria-hidden="true"></a>├── py</span>
<span id="cb2-46"><a href="#cb2-46" aria-hidden="true"></a>├── shared</span>
<span id="cb2-47"><a href="#cb2-47" aria-hidden="true"></a>├── tests</span>
<span id="cb2-48"><a href="#cb2-48" aria-hidden="true"></a>├── tools</span>
<span id="cb2-49"><a href="#cb2-49" aria-hidden="true"></a>└── user_mods</span>
<span id="cb2-50"><a href="#cb2-50" aria-hidden="true"></a>    ├── ME405</span>
<span id="cb2-51"><a href="#cb2-51" aria-hidden="true"></a>    └── ulab</span></code></pre></div>
</body>
</html>
